<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Custom Soundboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .sound-button {
            transition: all 0.05s ease-in-out;
            box-shadow: 0 2px 3px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            height: 60px; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; // ... inside handleSoundButtonClick
                                    soundData.player.onerror = (error) => {
                                        console.error(`Tone.Player Error for ${soundData.fileName}:`, error); // Check console for this
                                        showMessage(`Error loading: ${soundData.name.substring(0,20)}...`);
                                        placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                                        soundData.player = null;
                                    };
                                    await soundData.player.load(soundData.filePath);
            // ...
                            }).catch(err => { // Catch error from this specific load attempt
                                console.error("Error loading sound in promise (handleSoundButtonClick):", err); // And this
                                showMessage(`Error loading: ${soundData.name.substring(0,20)}...`);
                                placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                                soundData.player = null;
                            });
            // ...
            
            -webkit-box-orient: vertical; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            text-shadow: 
                1px 1px 0px rgba(0,0,0,0.2),
                2px 2px 0px rgba(0,0,0,0.15);
        }
        .sound-button.text-slate-800 {
             text-shadow: 1px 1px 0px rgba(255,255,255,0.3);
        }
        .sound-button:active:not(.editing) {
            transform: scale(0.93);
            box-shadow: 0 1px 1px -1px rgba(0, 0, 0, 0.1);
            text-shadow: none; 
        }
        .sound-button.playing { animation: pulse 0.2s ease-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        
        #message-box {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; background-color: rgba(0,0,0,0.75); color: white;
            border-radius: 6px; z-index: 1000; opacity: 0;
            transition: opacity 0.3s ease-in-out; pointer-events: none; font-size: 0.875rem;
        }
        #message-box.show { opacity: 1; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none;
            align-items: center; justify-content: center; z-index: 2000;
            overscroll-behavior: contain; 
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #2d3748; 
            padding: 20px; border-radius: 8px; width: 90%; max-width: 450px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-content label { margin-top: 10px; display: block; color: #a0aec0; }
        .modal-content input[type="text"], .modal-content input[type="search"], .modal-content select {
            width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px;
            background-color: #1a202c; color: white; border: 1px solid #4a5568; 
        }
        .color-swatch-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .color-swatch {
            width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
            border: 2px solid transparent;
        }
        .color-swatch.selected { border-color: #63b3ed; }
        .edit-mode-active #soundboard-grid .sound-button { cursor: pointer; }
        .edit-mode-active #soundboard-grid .sound-button:hover { filter: brightness(1.2); }

        .header-controls {
            display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;
            justify-content: center; margin-bottom: 0.5rem; padding: 0.5rem;
            background-color: rgba(45, 55, 72, 0.5); border-radius: 0.5rem; 
        }
        .header-controls input[type="search"], .header-controls select {
            padding: 0.5rem 0.75rem;
            background-color: #1e293b; 
            color: #e2e8f0; 
            border: 1px solid #334155; 
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .header-controls input[type="search"] {
            flex-grow: 1; min-width: 120px; max-width: 200px; 
        }
        .header-controls input[type="search"]::placeholder { color: #94a3b8; }
        .header-controls button {
            padding: 0.5rem 0.75rem; 
            font-weight: 600; border-radius: 0.375rem; 
            transition: background-color 0.2s; color: white; white-space: nowrap;
        }
        
        #category-tabs {
            display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;
            padding: 0.5rem; background-color: rgba(30, 41, 59, 0.5); 
            border-radius: 0.5rem; justify-content: center;
        }
        .category-tab {
            padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; 
            color: #cbd5e1; background-color: #334155; 
            border-radius: 0.375rem; cursor: pointer; transition: all 0.2s;
        }
        .category-tab:hover { background-color: #475569; color: white; }
        .category-tab.active { background-color: #0ea5e9; color: white; font-weight: 600; }

        .category-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem; border-bottom: 1px solid #4a5568; color: white;
        }
        .category-list-item button {
            margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex flex-col items-center p-4 selection:bg-sky-500 selection:text-white">

    <div class="w-full max-w-4xl mx-auto">
        <header class="my-6 md:mb-8 text-center">
            <div class="header-controls">
                <input type="search" id="search-bar" placeholder="Search sounds..." class="px-3 py-2">
                <button id="stop-all-sounds" class="bg-red-600 hover:bg-red-700">Stop All</button>
                <button id="manage-categories-btn" class="bg-purple-600 hover:bg-purple-700">Manage Cat.</button>
                <select id="sort-order-select">
                    <option value="default">Sort: Default</option>
                    <option value="alphabetical">Sort: Name (A-Z)</option>
                    <option value="category">Sort: Category, Name</option>
                </select>
                <button id="edit-mode-toggle" class="bg-sky-500 hover:bg-sky-600">Enable Editing</button>
            </div>
        </header>

        <div id="category-tabs">
            </div>

        <main id="soundboard-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 md:gap-3 p-3 bg-slate-800 rounded-xl shadow-2xl">
            </main>

        <footer class="mt-8 text-center">
            <p class="text-slate-500 text-xs md:text-sm">Powered by Tone.js</p>
        </footer>
    </div>

    <div id="message-box">Sound Playing!</div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4">Edit Sound Button</h3>
            <div>
                <label for="edit-button-name">Button Name:</label>
                <input type="text" id="edit-button-name" name="edit-button-name">
            </div>
            <div>
                <label for="edit-button-category">Category:</label>
                <select id="edit-button-category"></select>
            </div>
            <div>
                <label>Button Color:</label>
                <div id="edit-color-swatches" class="color-swatch-container"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-edit" class="px-4 py-2 bg-slate-500 hover:bg-slate-600 text-white rounded-md">Cancel</button>
                <button id="save-edit" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md">Save</button>
            </div>
        </div>
    </div>

    <div id="manage-categories-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4">Manage Categories</h3>
            <div class="mb-4">
                <label for="new-category-name">Add New Category:</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="new-category-name" placeholder="Category Name" class="flex-grow">
                    <button id="add-category-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md">Add</button>
                </div>
            </div>
            <h4 class="text-lg font-medium text-white mt-4 mb-2">Existing Categories:</h4>
            <div id="category-list" class="max-h-60 overflow-y-auto">
                </div>
            <div class="mt-6 flex justify-end">
                <button id="close-manage-categories-btn" class="px-4 py-2 bg-slate-500 hover:bg-slate-600 text-white rounded-md">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables & Constants ---
        let audioContextStarted = false;
        let isEditMode = false;
        let currentEditingOriginalIndex = -1;
        let sounds = []; 
        const activePlayers = {}; 
        let categories = ["Uncategorized", "Favorites"];
        let currentCategoryFilter = "All Sounds";
        let currentSortOrder = "default"; 
        const placeholderSynth = new Tone.Synth().toDestination(); // Synth for placeholder sounds

        const soundFileNames = [ 
            "2000 Years Later.ogg", "Accidents Happen.ogg", "Add up those figures sir.ogg", "Airhorn Buildup.ogg", 
            "Airhorn Classic.ogg", "Airhorn Fast.ogg", "Airhorn Sad.ogg", "Airplane.ogg", "All Star All Star.ogg", 
            "All this computer hacking is making me thirsty.ogg", "All you can talk about is Money.ogg", 
            "Americas going to be great again gang.ogg", "Anal Sex.ogg", "Angelic Holy Tone.ogg", "Another One.ogg", 
            "Are You High or Just Incredibly Stupid.ogg", "Are you sure about that.ogg", 
            "As long as the matrix exists the human race can never be free.ogg", "Asian Gong.ogg", "Aye Yi Yi Yi.ogg", 
            "Baby Elephant Walk FRIDGE.ogg", "Baby I got your Money - Song.ogg", "Bad Boys Theme.ogg", 
            "Bad to the Bone.ogg", "Banjo Deliverance.ogg", "Bank Notes for Millionaires.ogg", 
            "Banned from micky mouse club for inappropriate.ogg", "Beat up by a guy wearing a dress.ogg", 
            "Benny Hill Chase Silly.ogg", "Big cheer.ogg", "Bike Horn.ogg", "Bill Nye the Science Guy.ogg", 
            "Bing bing bong Thomas the train and Donald Trump.ogg", "Boing Tree.ogg", "Boing Two.ogg", "Boing.ogg", 
            "Bomb the shit out of them Trump.ogg", "Bottle Rocket.ogg", "Boxing Bell.ogg", "Breaking News 2.ogg", 
            "Breaking News 3.ogg", "Breaking News.ogg", "Bright Side of Life.ogg", "British.ogg", "Broken-glass.ogg", 
            "Brutal MK.ogg", "Buzzer.ogg", "Bye Felicia.ogg", "Camel.ogg", "Camera Click.ogg", "Can Do Sarcastic.ogg", 
            "Can You Dig lt.ogg", "Car Crash.ogg", "Cartoon Slipping.ogg", "Cash me outside how bout dat.ogg", 
            "Cat Angry.ogg", "Cheers.ogg", "Chewbaca.ogg", "Chicken-jockey.ogg", "Chinese Intro.ogg", 
            "Clapping Cheering.ogg", "Clapping Large Audience.ogg", "Clapping Medium Audience.ogg", 
            "Clapping Medium.ogg", "Clapping Normal.ogg", "Clapping Short.ogg", "Clapping Sus.ogg", 
            "Come on man.ogg", "Come-on-down.ogg", "Congratulations Trump.ogg", "Cop Siren.ogg", 
            "Credits Received.ogg", "Crickets.ogg", "Crowd Aww Cute.ogg", "Crowd Aww Loss.ogg", 
            "Crowd Aww Nooo.ogg", "Crowd Booo.ogg", "Crying Baby.ogg", "CSI Yeah.ogg", "Curb Enthusiasm.ogg", 
            "Curb-your-enthusiasm.ogg", "Did somebody say make Money Money.ogg", "Ding.ogg", "Dinosaur Groan.ogg", 
            "Do I look like I know what a Jpeg is.ogg", "Do not come.ogg", 
            "Do you ever look at someone and wonder what they are thinking.ogg", "Does he look like a bitch.ogg", 
            "Dogs.ogg", "Donkey.ogg", "Dracula Theme.ogg", "Drums 1min.ogg", "Drums Bongos.ogg", "Drums Medium.ogg", 
            "Drums Rim Shot.ogg", "Drums Ting.ogg", "Dun Dun Dunnnn.ogg", "Eagle.ogg", "Eat Shit Derek.ogg", 
            "Elephant.ogg", "English do you speak it.ogg", "Enoch.ogg", "Especially on weed man.ogg", 
            "Every Little Thing is Gonna Be Alright.ogg", "Evil Laugh.ogg", "Fairy.ogg", "Family Feud Theme.ogg", 
            "Fart Large.ogg", "Fart Two.ogg", "Fart.ogg", "Fatality.ogg", "Female scream.ogg", 
            "Flawless Victory MK.ogg", "Fox TV Theme.ogg", "Free credit report.ogg", "Friends Theme.ogg", 
            "Full House.ogg", "Future army soldier.ogg", "Fuuuck Long.ogg", "Gameshow Ending Wacky.ogg", 
            "Gasp.ogg", "Gay.ogg", "Get er Done.ogg", "Get help.ogg", "Get Swifty.ogg", "Ghost moan.ogg", 
            "Giligans Island Theme.ogg", "Give us some Money.ogg", "Godfather Theme.ogg", "Gonna Smoke Some Weed.ogg", 
            "Goofy car horn.ogg", "Gun Cock.ogg", "Gun Lazers Reggae.ogg", "Gun Lazers Tie Fighter.ogg", 
            "Gun Rapid Fire.ogg", "Gun Richochet Miss.ogg", "Gun Shot with Cock.ogg", "Ha Ha Ha Shut Up.ogg", 
            "Ha Ha Nelson.ogg", "Hackings Bad Trump.ogg", "Hallelujah.ogg", "Hawk Tuah Arnold.ogg", 
            "Hawk Tuah Short.ogg", "Hawk Tuah.ogg", "He He Jackson.ogg", "He was a Retard.ogg", "Helicopter.ogg", 
            "Hell naw.ogg", "Hello and welcome.ogg", "Hello Future Millionaires.ogg", 
            "Home Alone and Interested in Sex.ogg", "Hoo wee what a cliffhanger.ogg", 
            "Hopefully you didn't fuck around and waste your life.ogg", "Horse Running.ogg", "Horse Whinny.ogg", 
            "How Dare You.ogg", "How Good of You to Join Us Bane.ogg", "How it feels to chew 5 gum.ogg", 
            "I am a Millionaire - Trump.ogg", "I cant hear anything.ogg", "I can't take it anymore.ogg", 
            "I Caramba Bart.ogg", "I do not have any Money.ogg", "I dont give a fuuu.ogg", 
            "I don't remember Trump.ogg", "I dropped my monster condom.ogg", "I got hairy legs.ogg", 
            "I have to fufill my purpose so I can go away.ogg", "I really have nothing better to do Trump.ogg", 
            "I think moto like you.ogg", "I thought this was america.ogg", "I thought we had a deal.ogg", 
            "I-am-steve.ogg", "Im a Secret Agent.ogg", "Im Chris Hanson with Dateline NBC.ogg", "Im gonna come.ogg", 
            "Im gonna go kill myself.ogg", "Im Kinda Retarded.ogg", "Im making a donation.ogg", 
            "Im Sorry I was such a saint before.ogg", "Im Sorry.ogg", "In a few mins bitch.ogg", 
            "In San Fran its all about gay bath houses.ogg", "In the Arms of an Angel.ogg", "In the Navy.ogg", 
            "Inception.ogg", "India.ogg", "Irish.ogg", "It is Maam.ogg", "Its getting wierd.ogg", 
            "Its raining men hallelujah.ogg", "I've always been here for you guys and I always will be.ogg", 
            "I've been doing martial arts my whole life I dont wanna fight.ogg", "Ive fallen and I can't get up.ogg", 
            "I've Fallen and I can't get up.ogg", "Jade Pussycat.ogg", "Jammin Bob Marley.ogg", 
            "Jeopardy Theme.ogg", "Just do it.ogg", "Kaching.ogg", "Kells.ogg", "Ladies and Gentlemen we got em.ogg", 
            "Laughing Clap.ogg", "Laughing Fo.ogg", "Laughing One.ogg", "Laughing Sitcom.ogg", "Laughing Tree.ogg", 
            "Laughing Two.ogg", "Laughing.ogg", "Laverne and Shirley Theme.ogg", "Law and Order.ogg", 
            "Let her go.ogg", "Limit on Talking.ogg", "Looney Toons Theme.ogg", "LOSE Millionaire Short.ogg", 
            "LOSE Millionaire.ogg", "Lot of perverts in here.ogg", "Mad World.ogg", "Mario Coin.ogg", 
            "Mario Game Over.ogg", "Mario Lose Life.ogg", "Mario Power Up.ogg", "Mario Thank You so Much.ogg", 
            "Mash Theme.ogg", "Meow.ogg", "Metal Gear Alert.ogg", "Mexican Americans.ogg", "Mexican.ogg", 
            "Millionaire $$$5min.ogg", "Mingle Game.ogg", "Mission failed.ogg", "Mission Impossible.ogg", 
            "Money Money I want more Money.ogg", "Moneyyy Song.ogg", "Monkey.ogg", "Moo.ogg", "MotherFucker.ogg", 
            "My name Jeff.ogg", "Obama if we are racist.ogg", "Ohhh La La.ogg", "0k Lil Jon.ogg", "Oral Sex.ogg", 
            "Orgasm.ogg", "Pac Man Death.ogg", "Phone a Friend HOLD.ogg", "Pig.ogg", "Piglet Squel.ogg", 
            "Pinky and The Brain.ogg", "Pokemon.ogg", "Pornhub.ogg", "Price is right LOSE.ogg", "Punch.ogg", 
            "Puppy.ogg", "Radar.ogg", "Rehab Amy Winehouse.ogg", "Retard Alert.ogg", 
            "Right Near the Beach Boi.ogg", "Road Runner.ogg", "Roxanne.ogg", "Roxannel.ogg", "Sad Trombone.ogg", 
            "Sad Violin.ogg", "ScoobyDoo.ogg", "Seinfeld Intro.ogg", "Sex Change I Need It Now.ogg", 
            "She Shall Lure some Millionaire.ogg", "Sheep.ogg", "Show me the Money.ogg", "Shut the Fuck Up.ogg", 
            "Silly Spanish Flea FRIDGE.ogg", "ng Next to a Millionaire.ogg", "Smoke Weed Everyday.ogg", 
            "Spend your Money like Money aint Song.ogg", "Spongebob Fail.ogg", "Spring.ogg", 
            "Star Wars Cantina.ogg", "Step By Step.ogg", "Suicide.ogg", "Surpnse-supnse.ogg", "Suspense Harp.ogg", 
            "Suspense Medium.ogg", "Suspense Short.ogg", "Suspense Tuba.ogg", "Taco bell bong.ogg", "Tada.ogg", 
            "Taxes.ogg", "Tequila.ogg", "Thaaanks Sarcastic.ogg", "Thank You for the donation lady.ogg", 
            "Thank You for your patronage.ogg", "Thank You Rick.ogg", "Thank You South Park.ogg", 
            "Thank You Sweet.ogg", "That means your gay.ogg", "Thats a lot of Nuts.ogg", "Thats What She Said.ogg", 
            "The Adams Family Theme.ogg", "The Jeffersons Theme.ogg", "The more you know.ogg", 
            "The Most Important Thing is Money.ogg", "The Stripper.ogg", "Threes Company.ogg", 
            "Tim Allen Grunt Home Improvement.ogg", "Tip for you in my pocket.ogg", "Toilet.ogg", "Tree Fiddy.ogg", 
            "Trombone High Pitch.ogg", "Two and half men.ogg", "Universal Studios.ogg", "Vince Tammy.ogg", 
            "Walk like an egyptian.ogg", "Wasted.ogg", "Weakest Link.ogg", "Well Be Right Back.ogg", 
            "Were here to help.ogg", "Western crowd.ogg", "What are you a homo.ogg", 
            "What are you people on dope.ogg", "What da dog do.ogg", "What do you mean funny funny how.ogg", 
            "What is That Joke.ogg", "What Lil Jon.ogg", "What the hell is going on here exactly.ogg", 
            "What the hell is wrong with you people.ogg", "Whats the sound of one hand clapping.ogg", 
            "Where is the lamb sauce.ogg", "Wheres the rest of my meth.ogg", "Whip.ogg", 
            "White Dude for Harris.ogg", "Who is your daddy and what does he do.ogg", "Who the Hell Cares.ogg", 
            "Who's that Pokemon.ogg", "Why are you gay.ogg", "Why Can't We Be Friends.ogg", 
            "Why in the fuck would I do that.ogg", "Will I pay a lot of tax Trump.ogg", "WoHoo Homer.ogg", 
            "Wolf.ogg", "Wonka flute.ogg", "Woodpecker.ogg", "Wow Dude.ogg", "Wow kid.ogg", "Wow.ogg", 
            "Ya Science.ogg", "Yahoo.ogg", "Yeah Lil Jon.ogg", "Yeah Probably.ogg", "Yeah So What.ogg", 
            "Yeah this is gonna help with that bitch.ogg", "Yippee.ogg", "Yippeee.ogg", "You Belong To Me.ogg", 
            "You Can Do lt.ogg", "You Have Smoked Yourself Retarded.ogg", "You Lose MK.ogg", 
            "You sound like a gay.ogg", "You Suck You Jackass.ogg", "You Wanna Get High.ogg", 
            "Your Fired Trump.ogg", "Your Rights Are My Responsibilities.ogg", "You're a Millionaire.ogg"
        ];
        const colorPalette = [
            { base: "bg-red-500", hover: "hover:bg-red-600", focusRing: "focus:ring-red-400", text: "text-white" },
            { base: "bg-orange-500", hover: "hover:bg-orange-600", focusRing: "focus:ring-orange-400", text: "text-white" },
            { base: "bg-amber-500", hover: "hover:bg-amber-600", focusRing: "focus:ring-amber-400", text: "text-slate-800" },
            { base: "bg-yellow-500", hover: "hover:bg-yellow-600", focusRing: "focus:ring-yellow-400", text: "text-slate-800" },
            { base: "bg-lime-500", hover: "hover:bg-lime-600", focusRing: "focus:ring-lime-400", text: "text-slate-800" },
            { base: "bg-green-500", hover: "hover:bg-green-600", focusRing: "focus:ring-green-400", text: "text-white" },
            { base: "bg-emerald-500", hover: "hover:bg-emerald-600", focusRing: "focus:ring-emerald-400", text: "text-white" },
            { base: "bg-teal-500", hover: "hover:bg-teal-600", focusRing: "focus:ring-teal-400", text: "text-white" },
            { base: "bg-cyan-500", hover: "hover:bg-cyan-600", focusRing: "focus:ring-cyan-400", text: "text-slate-800" },
            { base: "bg-sky-500", hover: "hover:bg-sky-600", focusRing: "focus:ring-sky-400", text: "text-white" },
            { base: "bg-blue-500", hover: "hover:bg-blue-600", focusRing: "focus:ring-blue-400", text: "text-white" },
            { base: "bg-indigo-500", hover: "hover:bg-indigo-600", focusRing: "focus:ring-indigo-400", text: "text-white" },
            { base: "bg-violet-500", hover: "hover:bg-violet-600", focusRing: "focus:ring-violet-400", text: "text-white" },
            { base: "bg-purple-500", hover: "hover:bg-purple-600", focusRing: "focus:ring-purple-400", text: "text-white" },
            { base: "bg-fuchsia-500", hover: "hover:bg-fuchsia-600", focusRing: "focus:ring-fuchsia-400", text: "text-white" },
            { base: "bg-pink-500", hover: "hover:bg-pink-600", focusRing: "focus:ring-pink-400", text: "text-white" },
            { base: "bg-rose-500", hover: "hover:bg-rose-600", focusRing: "focus:ring-rose-400", text: "text-white" },
            // You can add more colors or adjust these ones
            // These are Tailwind CSS classes. Make sure they match your Tailwind setup.
            // The 'text' property is for the button text color.
            // Some light backgrounds might need a darker text like 'text-slate-800' for better contrast.
        ];

        // - DOM Elements -
        const soundboardGrid = document.getElementById('soundboard-grid');
        const messageBox = document.getElementById('message-box');
        const editModeToggle = document.getElementById('edit-mode-toggle');
        const editModal = document.getElementById('edit-modal');
        const editButtonNameInput = document.getElementById('edit-button-name');
        const editButtonCategorySelect = document.getElementById('edit-button-category');
        const editColorSwatchesContainer = document.getElementById('edit-color-swatches');
        const saveEditButton = document.getElementById('save-edit');
        const cancelEditButton = document.getElementById('cancel-edit');
        const searchBar = document.getElementById('search-bar');
        const stopAllSoundsButton = document.getElementById('stop-all-sounds');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const manageCategoriesModal = document.getElementById('manage-categories-modal');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryListDiv = document.getElementById('category-list');
        const closeManageCategoriesBtn = document.getElementById('close-manage-categories-btn');
        const sortOrderSelect = document.getElementById('sort-order-select');
        let messageTimeout;
        let selectedColorIndexInModal = 0;

        // - Initialization and Core Logic -
        function initializeSounds() {
            const buttonsPerColorBlock = 12;
            sounds = []; 
            soundFileNames.forEach((fileName, i) => {
                const colorPaletteIndex = Math.floor(i / buttonsPerColorBlock) % colorPalette.length;
                let displayName = fileName.replace(/\.ogg$/i, '').replace(//g, ' '); 
                sounds.push({
                    id: `sound-btn-${i}`, originalIndex: i, name: displayName, fileName: fileName, 
                    filePath: `sounds/${fileName}`, colorPaletteIndex: colorPaletteIndex, 
                    category: "Uncategorized", 
                    player: null 
                });
            });
        }

        function renderButtons(soundsToDisplay = getSoundsForCurrentFilter()) {
            soundboardGrid.innerHTML = ''; 
            soundsToDisplay.forEach((soundData) => {
                const button = document.createElement('button');
                button.id = soundData.id;
                button.textContent = soundData.name;
                const colorInfo = colorPalette[soundData.colorPaletteIndex];
                button.className = `sound-button w-full font-bold py-3 px-1 rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-opacity-75 ${generateColorClasses(colorInfo)} flex items-center justify-center text-center`;
                button.dataset.originalIndex = soundData.originalIndex; 
                button.addEventListener('click', handleSoundButtonClick);
                button.addEventListener('touchstart', handleSoundButtonClick, { passive: false });
                soundboardGrid.appendChild(button);
            });
        }

        function getSoundsForCurrentFilter() {
            let soundsToDisplay;
            if (currentCategoryFilter === "All Sounds") {
                soundsToDisplay = [...sounds]; 
            } else {
                soundsToDisplay = sounds.filter(s => s.category === currentCategoryFilter);
            }
            const searchTerm = searchBar.value.toLowerCase();
            if (searchTerm) {
                soundsToDisplay = soundsToDisplay.filter(s => s.name.toLowerCase().includes(searchTerm));
            }
            if (currentSortOrder === "alphabetical") {
                soundsToDisplay.sort((a, b) => a.name.localeCompare(b.name));
            } else if (currentSortOrder === "category") {
                soundsToDisplay.sort((a, b) => {
                    const catComp = a.category.toLowerCase().localeCompare(b.category.toLowerCase());
                    if (catComp !== 0) return catComp;
                    return a.name.localeCompare(b.name); 
                });
            } else { 
                 soundsToDisplay.sort((a,b) => a.originalIndex - b.originalIndex);
            }
            return soundsToDisplay;
        }
        
        function updateButtonDisplay(originalIndex) {
            const soundData = sounds[originalIndex]; 
            const buttonElement = document.getElementById(soundData.id); 
            if (buttonElement) {
                buttonElement.textContent = soundData.name;
                const colorInfo = colorPalette[soundData.colorPaletteIndex];
                buttonElement.className = `sound-button w-full font-bold py-3 px-1 rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-opacity-75 ${generateColorClasses(colorInfo)} flex items-center justify-center text-center`;
                 if (isEditMode) { 
                    buttonElement.classList.add('editing');
                }
            }
        }

        async function handleSoundButtonClick(event) {
            if (event.type === 'touchstart') event.preventDefault();
            const buttonElement = event.currentTarget; 
            const originalIndex = parseInt(buttonElement.dataset.originalIndex, 10);
            const soundData = sounds[originalIndex];

            if (isEditMode) {
                openEditModal(originalIndex);
            } else { 
                if (buttonElement.classList.contains('playing')) { 
                    if (soundData.player && soundData.player.state === "started") soundData.player.stop();
                }
                buttonElement.classList.add('playing');
                if (!audioContextStarted) {
                    try { await Tone.start(); audioContextStarted = true; } 
                    catch (e) { 
                        showMessage("Error: Could not start audio."); 
                        buttonElement.classList.remove('playing'); 
                        return; 
                    }
                }
                try {
                    if (!soundData.player || soundData.player.disposed) { 
                        soundData.player = new Tone.Player().toDestination(); // Create player
                        activePlayers[originalIndex] = soundData.player; 
                        // Attach an error handler to the player itself for loading issues
                        soundData.player.onerror = (error) => {
                            console.error(`Tone.Player Error for ${soundData.fileName}:`, error);
                            showMessage(`Error loading: ${soundData.name.substring(0,20)}...`);
                            placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                            soundData.player = null; // Mark as not usable
                        };
                        await soundData.player.load(soundData.filePath); // Load the sound
                    }
                    
                    if (soundData.player && soundData.player.loaded) { // Check if player exists and is loaded
                        soundData.player.start();
                        // showMessage(`Playing: ${soundData.name}`); // Can be too noisy
                    } else if (soundData.player && !soundData.player.loaded) { // Player exists but not loaded (might happen if load was interrupted)
                        showMessage(`Loading: ${soundData.name}...`);
                        soundData.player.load(soundData.filePath).then(() => { // Try loading again
                             soundData.player.start();
                        }).catch(err => { // Catch error from this specific load attempt
                            console.error("Error loading sound in promise (handleSoundButtonClick):", err);
                            showMessage(`Error loading: ${soundData.name.substring(0,20)}...`);
                            placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                            soundData.player = null; // Mark as not usable
                        });
                    } else { // No player, means previous load failed and it was set to null
                         console.warn(`Player for ${soundData.fileName} is null, playing placeholder.`);
                         showMessage(`Placeholder: ${soundData.name.substring(0,20)}...`);
                         placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                    }
                } catch (error) { // General catch for other errors during playback attempt
                    showMessage(`Error: ${soundData.name.substring(0,20)}...`); 
                    console.error("General error in handleSoundButtonClick:", error);
                    placeholderSynth.triggerAttackRelease("C5", "8n", Tone.now());
                } finally { 
                    setTimeout(() => buttonElement.classList.remove('playing'), 300); // Reduced delay
                }
            }
        }
        
        function renderCategoryTabs() {
            categoryTabsContainer.innerHTML = '';
            const allSoundsTab = document.createElement('button');
            allSoundsTab.textContent = "All Sounds";
            allSoundsTab.className = `category-tab ${currentCategoryFilter === "All Sounds" ? "active" : ""}`;
            allSoundsTab.addEventListener('click', () => {
                currentCategoryFilter = "All Sounds";
                searchBar.value = ""; 
                renderCategoryTabs();
                renderButtons();
            });
            categoryTabsContainer.appendChild(allSoundsTab);

            categories.forEach(catName => {
                const tab = document.createElement('button');
                tab.textContent = catName;
                tab.className = `category-tab ${currentCategoryFilter === catName ? "active" : ""}`;
                tab.addEventListener('click', () => {
                    currentCategoryFilter = catName;
                    searchBar.value = ""; 
                    renderCategoryTabs();
                    renderButtons();
                });
                categoryTabsContainer.appendChild(tab);
            });
        }

        function openManageCategoriesModal() {
            renderCategoryListInModal();
            manageCategoriesModal.classList.add('show');
        }
        function closeManageCategoriesModal() { manageCategoriesModal.classList.remove('show'); }

        function renderCategoryListInModal() {
            categoryListDiv.innerHTML = '';
            categories.forEach(catName => {
                const item = document.createElement('div');
                item.className = 'category-list-item';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = catName;
                item.appendChild(nameSpan);

                const controlsDiv = document.createElement('div');
                const renameBtn = document.createElement('button');
                renameBtn.textContent = "Rename";
                renameBtn.className = "bg-blue-500 hover:bg-blue-600 text-white";
                renameBtn.onclick = () => renameCategory(catName);
                controlsDiv.appendChild(renameBtn);

                if (catName !== "Uncategorized") { 
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = "Delete";
                    deleteBtn.className = "bg-red-500 hover:bg-red-600 text-white";
                    deleteBtn.onclick = () => deleteCategory(catName);
                    controlsDiv.appendChild(deleteBtn);
                }
                item.appendChild(controlsDiv);
                categoryListDiv.appendChild(item);
            });
        }

        function addCategory() {
            const newName = newCategoryNameInput.value.trim();
            if (newName && !categories.includes(newName)) {
                categories.push(newName);
                categories.sort((a,b) => a === "Uncategorized" ? -1 : b === "Uncategorized" ? 1 : a.localeCompare(b)); 
                newCategoryNameInput.value = '';
                renderCategoryTabs();
                renderCategoryListInModal();
                showMessage(`Category "${newName}" added.`);
            } else if (categories.includes(newName)) {
                showMessage(`Category "${newName}" already exists.`);
            } else {
                showMessage("Please enter a valid category name.");
            }
        }

        function renameCategory(oldName) {
            const newName = prompt(`Rename category "${oldName}" to:`, oldName);
            if (newName && newName.trim() !== "" && !categories.includes(newName.trim()) && newName.trim() !== oldName) {
                const updatedName = newName.trim();
                const index = categories.indexOf(oldName);
                if (index > -1) categories[index] = updatedName;
                sounds.forEach(sound => { if (sound.category === oldName) sound.category = updatedName; });
                if(currentCategoryFilter === oldName) currentCategoryFilter = updatedName;
                renderCategoryTabs(); renderCategoryListInModal(); renderButtons();
                showMessage(`Category "${oldName}" renamed to "${updatedName}".`);
            } else if (categories.includes(newName.trim())) {
                showMessage(`Category "${newName.trim()}" already exists.`);
            }
        }

        function deleteCategory(catNameToDelete) {
            if (catNameToDelete === "Uncategorized") { showMessage("Cannot delete 'Uncategorized'."); return; }
            if (confirm(`Delete category "${catNameToDelete}"? Sounds will move to "Uncategorized".`)) {
                categories = categories.filter(c => c !== catNameToDelete);
                sounds.forEach(sound => { if (sound.category === catNameToDelete) sound.category = "Uncategorized"; });
                if (currentCategoryFilter === catNameToDelete) currentCategoryFilter = "All Sounds";
                renderCategoryTabs(); renderCategoryListInModal(); renderButtons();
                showMessage(`Category "${catNameToDelete}" deleted.`);
            }
        }
        
        function populateCategoryDropdown(selectElement, selectedCategory) {
            selectElement.innerHTML = '';
            categories.forEach(catName => {
                const option = document.createElement('option');
                option.value = catName; option.textContent = catName;
                if (catName === selectedCategory) option.selected = true;
                selectElement.appendChild(option);
            });
        }

        function openEditModal(originalIndex) {
            currentEditingOriginalIndex = originalIndex;
            const soundData = sounds[originalIndex]; 
            editButtonNameInput.value = soundData.name;
            populateCategoryDropdown(editButtonCategorySelect, soundData.category);
            editColorSwatchesContainer.innerHTML = ''; 
            colorPalette.forEach((color, i) => {
                const swatch = document.createElement('div');
                swatch.className = `color-swatch ${color.base}`;
                swatch.dataset.colorIndex = i;
                if (i === soundData.colorPaletteIndex) {
                    swatch.classList.add('selected'); selectedColorIndexInModal = i;
                }
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('#edit-color-swatches .color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected'); selectedColorIndexInModal = i;
                });
                editColorSwatchesContainer.appendChild(swatch);
            });
            editModal.classList.add('show');
        }
        function closeEditModal() { editModal.classList.remove('show'); currentEditingOriginalIndex = -1; }
        function saveChanges() {
            if (currentEditingOriginalIndex === -1) return;
            const newName = editButtonNameInput.value.trim();
            if (newName) sounds[currentEditingOriginalIndex].name = newName;
            sounds[currentEditingOriginalIndex].colorPaletteIndex = selectedColorIndexInModal;
            sounds[currentEditingOriginalIndex].category = editButtonCategorySelect.value;
            updateButtonDisplay(currentEditingOriginalIndex); 
            renderButtons(); 
            closeEditModal();
            showMessage("Changes saved!");
        }

        function generateColorClasses(colorPaletteEntry) { return `${colorPaletteEntry.base} ${colorPaletteEntry.hover} ${colorPaletteEntry.focusRing} ${colorPaletteEntry.text}`; }
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode-active', isEditMode);
            editModeToggle.textContent = isEditMode ? "Disable Editing" : "Enable Editing";
            editModeToggle.classList.toggle('bg-sky-500', !isEditMode);
            editModeToggle.classList.toggle('hover:bg-sky-600', !isEditMode);
            editModeToggle.classList.toggle('bg-red-500', isEditMode);
            editModeToggle.classList.toggle('hover:bg-red-600', isEditMode);
            showMessage(isEditMode ? "Editing Enabled" : "Editing Disabled");
            document.querySelectorAll('.sound-button').forEach(btn => btn.classList.toggle('editing', isEditMode));
        }
        function handleSearch() { renderButtons(); }
        function handleSortChange() {
            currentSortOrder = sortOrderSelect.value;
            renderButtons();
        }
        function stopAllSounds() {
            if (!audioContextStarted) { showMessage("Audio not started."); return; }
            Tone.Player.stopAll();
            Tone.Transport.stop(); Tone.Transport.cancel(0); 
            showMessage("All sounds stopped!");
        }
        function showMessage(text) {
            messageBox.textContent = text; messageBox.classList.add('show');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => messageBox.classList.remove('show'), 2000);
        }

        // --- Event Listeners ---
        editModeToggle.addEventListener('click', toggleEditMode);
        saveEditButton.addEventListener('click', saveChanges);
        cancelEditButton.addEventListener('click', closeEditModal);
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });
        searchBar.addEventListener('input', handleSearch);
        stopAllSoundsButton.addEventListener('click', stopAllSounds);
        manageCategoriesBtn.addEventListener('click', openManageCategoriesModal);
        addCategoryBtn.addEventListener('click', addCategory);
        closeManageCategoriesBtn.addEventListener('click', closeManageCategoriesModal);
        manageCategoriesModal.addEventListener('click', (e) => { if (e.target === manageCategoriesModal) closeManageCategoriesModal(); });
        sortOrderSelect.addEventListener('change', handleSortChange);

        // --- Initialization ---
        if (typeof Tone === 'undefined') {
            showMessage("Error: Audio library (Tone.js) not loaded.");
        } else {
            initializeSounds();
            renderCategoryTabs();
            renderButtons(); 
            document.title = `Soundboard - ${sounds.length} Sounds`; 
        }
    </script>
</body>
</html>
